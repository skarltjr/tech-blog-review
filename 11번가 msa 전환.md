- https://www.youtube.com/watch?v=J-VP0WFEQsY


1. 공통모듈의 재앙
```
- 공통 코드의 수정이 여러 모듈의 장애를 가져온다
- 200만 라인의 공통 코드의 양이 매우커서 ide로 띄우기도 버거운 환경/ 메모리 부족
```

2. 어디서부터 어떻게 전환해야하는가?
```
- 사용하지 않는 코드도 매우 많으며
- 정적 분석이 되지 않는 코드도 많고 / 리플렉션

-> 점진적 전환
```

3. 기존구조
```
단일 서버에 모든 ui부터 쿼리까지 모두 다 들어있다
당연히 단일 장애의 전파력이 매우 크다
```

4. spring cloud 도입
```
- netflix oss를 도입한 이유는 
  - 이미 이 회사가 프로덕션에서 사용을 마친 / 검증된
  - 개발자들에게 친숙한 스프링부트
```

5. Hystrix
```
흔히 스프링클라우드에서 제공하는 서킷 브레이커라고 "잘못" 알려짐

실제로는 
넷플릭스가 만든 장애 전파 방지 & resilience

기능적 관점으로 본다면 
- circuit breaker
- fallback
- thread isolation
- timeout
```
```
hystrix command를 호출할때 벌어지는 일

1. 특정 매서드를 intercept하여 대신 실행
- thread isoltion
- 예를들어 api를 호출하는 caller와 이를 수행하는 callee가 서로 다른 스레드
- 즉 도중에 다른애가 가로채서 이를 실행

2. 매서드의 실행 결과를 모두 기록하고 통계를 낸다
- 이를 바탕으로 서킷 브레이커 동작 여부를 결정 

3. 실패(exception)가 발생하면 지정한 매서드를 대신 실행
- 예를들어 개개인마다 추천 목록 매서드 호출이 실패한다면?
- 미리 지정해둔 고정된 상품 목록 매서드를 호출하여 사용자에게 제공

4. 특정 시간동안 매서드가 종료되지 않는 경우 exception
- timeout
- hystrix로 감싼 매서드를 대상으로
```

### circuit breaker
```
- 예를들어 a매서드가 요청 중 절반이 실패한다
-> circuit breaker를 오픈하여 해당 기능을 차단한다
-> 빠른 실패를 유도한다

빠른 실패의 중요성
- 가령 우리 서버 중 일부가 외부 B서버와 연동을 하고 있고 B서버가 장애가 발생하여 응답이 지연되면
- 이로인해 우리 서버도 처리속도가 저하되고 이게 쌓이면 우리 서버가 망가진다
- 따라서 사전에 미리 차단하여 이른 실패를 유도함으로써 서버의 안정성을 갖추고 유저는 빠른 응답을 받아 다음 행위를 한다


실제 Hystrix의 서킷 브레이커를 사용할때 가장 중요한 판단 부분은
어느 정도의 매서드 단위를 함께 묶을것인가.

- 개별 매서드 각각에 모두 서킷 브레이커를 적용하면
  - 실제로 초당 10번도 안들어오는 매서드인데 리소스 잡아먹게된다
  
- 만약 너무 큰 묶음 단위로 적용하면?
  - 크게 상관없는 매서드로 인해 묶음에 포함된 모든 매서드가 차단된다.
```
### Fallback
```
fallback으로 지정된 매서드는 다음 경우에 원본 매서드 대신 실행된다
- circuit open
- any exception ( HystrixBadRequestException 제외 - 사용자의 실수로 발생하는 예외를 HystrixBadRequestException으로 감싸고 이는 서버의 문제가 아니니까 제외시킨다)
- semaphore / threadpool rejection
- timeout
```
```
⭐️ 조심해라 fallback은 잘못 사용하면 문제된다 / 우리 에러를 감춰버리는 문제가 될 수 있다
```

