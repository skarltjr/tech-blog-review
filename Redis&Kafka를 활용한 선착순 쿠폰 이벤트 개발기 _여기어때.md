- https://techblog.gccompany.co.kr/redis-kafka를-활용한-선착순-쿠폰-이벤트-개발기-feat-네고왕-ec6682e39731


### 1. 문제
```
1. 기존 쿠폰 시스템은 RDB에 의존하여 수량 체크가 이루어진다.
- 동시성 이슈로 쿠폰 초과 지급 가능성 존재

2. 모놀리식 구조
- 쿠폰 시스템의 장애 -> 여기어때 서비스 전체에 장애 전파 가능성
```
```
내 생각
1. 
- 예를들어 mysql - rdb를 사용한다면 트랜잭션 격리 수준2로 보완할 수 있지않을까?
- 그러나 격리수준 2레벨이면서 & b+tree에서 데이터 조회는 성능 측면에서 키-값 구조의 redis보다 훨씬 느릴것이라고 생각
- 만약 조회에서 인덱스를 사용한다고해도 지금 여기서는 쿠폰 발급 카운트를 ++해야하는데 그럼 수정이 엄청 빈번함

2. 
쿠폰 개수 카운트 시스템
쿠폰 발급 시스템으로 분리하는게 좋을 것 같다.
그리고 서비스간 동기 통신을 피해 서비스간 의존성을 끊어내야한다고 생각
```

### 2. 쿠폰 발급 이벤트 요구사항
```
- 정해진 지급 수량을 초과하면 안된다
- 쿠폰은 1인 1장⭐️
```

### 3. 해결 방법 및 판단 근거
```
1. 동시성 문제와 요구사항 충족을 위한 Redis 활용
- 단일 스레드 기반으로 커맨드를 순차적으로 처리할 수 있다
- 키-밸류를 통해 빠른 조회
- INCR 커맨드는 특정 값을 1씩 증가시키는 커맨드로 시간복잡도 O(1)
  -> 발행시 쿠폰 개수를 증가시키고 최대 수량을 넘으면 x
- 다양한 자료구조 그 중 set을 통해 userId 중복 검사
  -> 중복 발급 방지
```

```
여전히 남은 문제점 : 
그러나 redis를 활용해도 동시성 문제가 발생한다./ 초과 지급이 발생

- 총 100개 쿠폰 중 99개가 발급된 상황
- 여기서 두 유저가 동시에 발급 신청
- 두 요청이 모두 현재 마지막 하나 발급이 가능하다고 판단하고 진행
```
- <img width="726" alt="스크린샷 2022-08-15 오후 4 01 47" src="https://user-images.githubusercontent.com/62214428/184590674-867f5c7b-990d-4600-bf29-958b6df4e449.png">
```
어떻게 해결할까??
내 생각은 일단 트랜잭션을 활용한다
예를들어 트랜잭션 격리수준 2레벨에서 
동일 데이터를 먼저 건드리는 트랜잭션이 존재한다면 현재 트랜잭션은 앞선 트랜잭션이 종료된 후 이를 처리
이를통해 동시성 이슈를 해결할 수 있을거라고 생각

------
redis 역시 트랜잭션을 제공하고
redis의 트랜잭션은 여러 커맨드 묶음에 대하여 순차처리를 보장
다만 트랜잭션 롤백은 불가로 애플리케이션에서 이를 구현해야한다.
```

-------
```
2. 시스템간 장애의 전파
크게 두 개의 시스템으로 분리함으로써 해결

1번 서비스 : 
- 쿠폰 지급 가능여부 판단 서비스
  - redis에 접근하여 현재 유저 아이디로 발급받은적이 있는지 확인
  - 현재까지 지급된 쿠폰 개수 +1 가능한지(추가 발급 가능한지) 판단 후 ++
  - 이때 위 행위들을 트랜잭션으로 묶어 수행 및 실패시 롤백 추가 구현
  - 이후 실제 쿠폰 발급을 위해 쿠폰 발급 서비스에 이벤트 발행
1번 서비스를 통해
- 초과 지급, 중복 지급을 해결하며
- redis 트랜잭션은 순차 처리를 활용하여 동시성 문제 해결

2번 서비스 :
- 쿠폰 발급 서비스
  - 쿠폰 발행 이벤트 consume

이때 서비스간 통신은 이벤트기반 비동기통신
- 서비스간 의존성 제거
- 장애의 전파 제거
```
